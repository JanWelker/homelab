apiVersion: apps/v1
kind: Deployment
metadata:
  name: pelican
  labels:
    app: pelican
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pelican
  template:
    metadata:
      labels:
        app: pelican
    spec:
      # Init container: Clone repo and build HTML with Pelican
      initContainers:
        - name: pelican-build
          image: python:3.12-slim
          envFrom:
            - configMapRef:
                name: pelican-config
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Installing Pelican and dependencies..."
              pip install --quiet pelican markdown

              echo "Cloning content repository..."
              apt-get update && apt-get install -y --no-install-recommends git
              git clone --depth 1 --branch ${PELICAN_BRANCH} ${PELICAN_REPO} /src

              echo "Building site with Pelican..."
              cd /src

              # Set SITEURL in pelicanconf.py if it exists
              if [ -f pelicanconf.py ]; then
                echo "SITEURL = '${SITEURL}'" >> pelicanconf.py
              fi

              pelican content -o /output -s pelicanconf.py

              echo "Build complete! Files in /output:"
              ls -la /output
          volumeMounts:
            - name: html-content
              mountPath: /output
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"

      # Main container: Serve the built HTML with nginx
      containers:
        - name: nginx
          image: nginx:alpine
          ports:
            - containerPort: 80
              name: http
          volumeMounts:
            - name: html-content
              mountPath: /usr/share/nginx/html
              readOnly: true
            - name: nginx-config
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: default.conf
          resources:
            requests:
              memory: "32Mi"
              cpu: "10m"
            limits:
              memory: "64Mi"
              cpu: "100m"
          livenessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 5
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 3
            periodSeconds: 5

      volumes:
        - name: html-content
          emptyDir: {}
        - name: nginx-config
          configMap:
            name: nginx-config
