# yaml-language-server: $schema=https://raw.githubusercontent.com/argoproj/argo-cd/master/manifests/crds/application-crd.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: nextcloud
  namespace: argocd
  annotations:
    link.argocd.argoproj.io/external-link: https://cloud.k8s.wlkr.ch
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  # Multiple sources: Helm chart + local manifests (HTTPRoute)
  sources:
    # Source 1: Nextcloud Helm chart
    - repoURL: https://nextcloud.github.io/helm/
      chart: nextcloud
      targetRevision: 8.7.0
      helm:
        valuesObject:
          nextcloud:
            host: cloud.k8s.wlkr.ch
            # Maintenance window (3 AM UTC - low usage time)
            configs:
              maintenance.config.php: |-
                <?php
                $CONFIG = array (
                  'maintenance_window_start' => 3,
                );

          # HTTPS configuration
          phpClientHttpsFix:
            enabled: true
            protocol: https

          ingress:
            enabled: false # Using Gateway API instead

          # Persistence for Nextcloud data
          persistence:
            enabled: true
            size: 10Gi
            storageClass: rook-ceph-block

          # PostgreSQL database (instead of SQLite)
          postgresql:
            enabled: true
            global:
              postgresql:
                auth:
                  username: nextcloud
                  password: nextcloud-db-password # TODO: Use existingSecret in production
                  database: nextcloud
            primary:
              persistence:
                enabled: true
                storageClass: rook-ceph-block
                size: 5Gi

          # Redis for caching (session, file locking)
          redis:
            enabled: true
            auth:
              enabled: true
              password: nextcloud-redis-password # TODO: Use existingSecret in production
            master:
              persistence:
                enabled: true
                storageClass: rook-ceph-block
                size: 1Gi
            replica:
              persistence:
                enabled: true
                storageClass: rook-ceph-block
                size: 1Gi

          # Background jobs (cron)
          cronjob:
            enabled: true
            type: sidecar # Runs as sidecar container

    # Source 2: Local manifests (HTTPRoute, etc.)
    - repoURL: https://github.com/JanWelker/homelab.git
      targetRevision: HEAD
      path: payload/apps/nextcloud
      directory:
        exclude: "application.yaml" # Don't include the Application itself
  destination:
    server: https://kubernetes.default.svc
    namespace: nextcloud
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
