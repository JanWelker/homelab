apiVersion: batch/v1
kind: Job
metadata:
  name: rook-ceph-dashboard-config
  namespace: rook-ceph
  annotations:
    argocd.argoproj.io/sync-wave: "5" # Run after cluster is fully up
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      containers:
        - name: config
          image: rook/ceph:v1.16.1
          command: ["/bin/bash", "-c"]
          args:
            - |
              # Wait for mgr to be ready with retry loop
              MAX_RETRIES=30
              RETRY_DELAY=10

              for i in $(seq 1 $MAX_RETRIES); do
                echo "Attempt $i: Setting dashboard config..."
                if ceph dashboard set-prometheus-api-host http://kube-prometheus-stack-prometheus.monitoring.svc.cluster.local:9090; then
                  echo "Successfully set Prometheus host."
                  ceph dashboard set-grafana-api-url http://kube-prometheus-stack-grafana.monitoring.svc.cluster.local:80
                  ceph dashboard set-grafana-api-ssl-verify false
                  echo "Dashboard configured successfully."
                  exit 0
                fi
                echo "Command failed. Retrying in $RETRY_DELAY seconds..."
                sleep $RETRY_DELAY
              done

              echo "Failed to configure dashboard after $MAX_RETRIES attempts."
              exit 1
          volumeMounts:
            - name: mon-endpoint-volume
              mountPath: /etc/rook
            - name: ceph-config
              mountPath: /etc/ceph
            - name: ceph-admin-secret
              mountPath: /var/lib/rook-ceph-mon
      volumes:
        - name: mon-endpoint-volume
          configMap:
            name: rook-ceph-mon-endpoints
            items:
              - key: data
                path: mon-endpoints
        - name: ceph-config
          emptyDir: {}
        - name: ceph-admin-secret
          secret:
            secretName: rook-ceph-mon
            items:
              - key: ceph-secret
                path: secret.keyring
      restartPolicy: OnFailure
      serviceAccountName: rook-ceph-default
