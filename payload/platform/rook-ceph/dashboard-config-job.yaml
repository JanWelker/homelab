---
apiVersion: batch/v1
kind: Job
metadata:
  name: rook-ceph-dashboard-config
  namespace: rook-ceph
  annotations:
    argocd.argoproj.io/sync-wave: "5"
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      containers:
        - name: config
          image: rook/ceph:v1.19.1@sha256:2ddb6462ce74a395645b17894d3b805bf7f824acff553b778960df1347e2d046
          command: ["/bin/bash", "-c"]
          args:
            - |
              # Generate ceph.conf and keyring
              CEPH_CONFIG="/etc/ceph/ceph.conf"
              MON_CONFIG="/etc/rook/mon-endpoints"
              KEYRING_FILE="/etc/ceph/keyring"

              mon_endpoints=$(cat ${MON_CONFIG} | sed 's/[a-z0-9_-]\+=//g')
              ceph_secret=$(cat /var/lib/rook-ceph-mon/secret.keyring)

              cat <<EOF > ${CEPH_CONFIG}
              [global]
              mon_host = ${mon_endpoints}
              [client.admin]
              keyring = ${KEYRING_FILE}
              EOF

              cat <<EOF > ${KEYRING_FILE}
              [client.admin]
              key = ${ceph_secret}
              EOF

              # Wait for mgr to be ready with retry loop
              MAX_RETRIES=30
              RETRY_DELAY=10
              PROM_HOST="http://kube-prometheus-stack-prometheus.monitoring.svc.cluster.local:9090"
              GRAF_URL="http://kube-prometheus-stack-grafana.monitoring.svc.cluster.local:80"

              for i in $(seq 1 $MAX_RETRIES); do
                echo "Attempt $i: Setting dashboard config..."
                if ceph dashboard set-prometheus-api-host $PROM_HOST; then
                  echo "Successfully set Prometheus host."
                  ceph dashboard set-grafana-api-url $GRAF_URL
                  ceph dashboard set-grafana-api-ssl-verify false
                  echo "Dashboard configured successfully."
                  exit 0
                fi
                echo "Command failed. Retrying in $RETRY_DELAY seconds..."
                sleep $RETRY_DELAY
              done

              echo "Failed to configure dashboard after $MAX_RETRIES attempts."
              exit 1
          volumeMounts:
            - name: mon-endpoint-volume
              mountPath: /etc/rook
            - name: ceph-config
              mountPath: /etc/ceph
            - name: ceph-admin-secret
              mountPath: /var/lib/rook-ceph-mon
      volumes:
        - name: mon-endpoint-volume
          configMap:
            name: rook-ceph-mon-endpoints
            items:
              - key: data
                path: mon-endpoints
        - name: ceph-config
          emptyDir: {}
        - name: ceph-admin-secret
          secret:
            secretName: rook-ceph-mon
            items:
              - key: ceph-secret
                path: secret.keyring
      restartPolicy: OnFailure
      serviceAccountName: rook-ceph-default
