variant: flatcar
version: 1.0.0
passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - "{{ lookup('file', '~/.ssh/id_ed25519.pub') }}"
storage:
  disks:
    - device: /dev/nvme0n1
      wipe_table: true
      partitions:
        - label: data
          number: 0
          size_mib: 0
  filesystems:
    - path: /var/lib/containerd
      device: /dev/disk/by-partlabel/data
      format: ext4
      with_mount_unit: true
  files:
    - path: /etc/containerd/config.toml
      mode: 0644
      contents:
        inline: |
          version = 2
          [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
            runtime_type = "io.containerd.runc.v2"
          [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
            SystemdCgroup = true
    - path: /etc/hostname
      mode: 0644
      contents:
        inline: "{{ inventory_hostname }}"

    - path: /opt/kubeadm-config.yaml
      mode: 0644
      contents:
        inline: |
          {{ lookup('template', '../templates/kubeadm.yaml.j2') | indent(10) }}
    - path: /etc/modules-load.d/k8s.conf
      mode: 0644
      contents:
        inline: |
          overlay
          br_netfilter
    - path: /etc/sysctl.d/k8s.conf
      mode: 0644
      contents:
        inline: |
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward = 1


    - path: /etc/sysupdate.kubernetes.d/kubernetes.conf
      contents:
        source: http://{{ boot_server_ip }}:8000/kubernetes.conf
    - path: /opt/extensions/kubernetes/kubernetes-{{ kubernetes_version }}-x86-64.raw
      contents:
        source: http://{{ boot_server_ip }}:8000/kubernetes-{{ kubernetes_version }}-x86-64.raw
    - path: /etc/sysupdate.d/containerd.conf
      contents:
        source: http://{{ boot_server_ip }}:8000/containerd.conf
    - path: /opt/extensions/containerd/containerd-{{ containerd_version }}-x86-64.raw
      contents:
        source: http://{{ boot_server_ip }}:8000/containerd-{{ containerd_version }}-x86-64.raw
    - path: /etc/sysupdate.d/noop.conf
      contents:
        source: http://{{ boot_server_ip }}:8000/noop.conf
  links:
    - path: /etc/extensions/docker-flatcar.raw
      target: /dev/null
      overwrite: true
    - path: /etc/extensions/containerd-flatcar.raw
      target: /dev/null
      overwrite: true
    - path: /etc/extensions/containerd.raw
      target: /opt/extensions/containerd/containerd-{{ containerd_version }}-x86-64.raw
      overwrite: true
    - path: /etc/extensions/kubernetes.raw
      target: /opt/extensions/kubernetes/kubernetes-{{ kubernetes_version }}-x86-64.raw
      overwrite: true

systemd:
  units:
    - name: kubelet.service
      enabled: true
      dropins:
        - name: 20-kubelet.conf
          contents: |
            [Service]
            ExecStart=
            ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS
    - name: systemd-sysupdate.timer
      enabled: true
    - name: systemd-sysupdate.service
      dropins:
        - name: containerd.conf
          contents: |
            [Service]
            ExecStartPre=/usr/bin/sh -c "readlink --canonicalize /etc/extensions/containerd.raw > /tmp/containerd"
            ExecStartPre=/usr/lib/systemd/systemd-sysupdate -C containerd update
            ExecStartPost=/usr/bin/sh -c "readlink --canonicalize /etc/extensions/containerd.raw > /tmp/containerd-new"
            ExecStartPost=/usr/bin/sh -c "if ! cmp --silent /tmp/containerd /tmp/containerd-new; then touch /run/reboot-required; fi"

        - name: kubernetes.conf
          contents: |
            [Service]
            ExecStartPre=/usr/bin/sh -c "readlink --canonicalize /etc/extensions/kubernetes.raw > /tmp/kubernetes"
            ExecStartPre=/usr/lib/systemd/systemd-sysupdate -C kubernetes update
            ExecStartPost=/usr/bin/sh -c "readlink --canonicalize /etc/extensions/kubernetes.raw > /tmp/kubernetes-new"
            ExecStartPost=/usr/bin/sh -c "if ! cmp --silent /tmp/kubernetes /tmp/kubernetes-new; then touch /run/reboot-required; fi"
    - name: containerd.service
      dropins:
        - name: 10-config.conf
          contents: |
            [Service]
            Environment=CONTAINERD_CONFIG=/etc/containerd/config.toml
    - name: locksmithd.service
      mask: true
    - name: bootstrap-k8s.service
      enabled: true
      contents: |
        [Unit]
        Description=Bootstrap Kubernetes Cluster
        After=network-online.target
        Wants=network-online.target
        ConditionPathExists=!/etc/kubernetes/kubelet.conf

        [Service]
        Type=oneshot
        {% if role == 'control-plane' %}
        {% if inventory_hostname == groups['control_plane'][0] %}
        ExecStart=/usr/bin/kubeadm init --config /opt/kubeadm-config.yaml --upload-certs

        {% else %}
        ExecStart=/usr/bin/kubeadm join {{ control_plane_endpoint }} --token {{ kubeadm_token }} --discovery-token-unsafe-skip-ca-verification --control-plane --certificate-key {{ certificate_key }}
        {% endif %}
        {% else %}
        ExecStart=/usr/bin/kubeadm join {{ control_plane_endpoint }} --token {{ kubeadm_token }} --discovery-token-unsafe-skip-ca-verification
        {% endif %}

        [Install]
        WantedBy=multi-user.target
