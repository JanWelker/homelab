---
- name: Generate Configurations
  hosts: k8s_nodes
  connection: local
  gather_facts: false
  vars:
    output_dir: "{{ playbook_dir }}/../../output"
  tasks:
    - name: Ensure credentials directory exists
      ansible.builtin.file:
        path: "{{ playbook_dir }}/../../output/credentials"
        state: directory
        mode: "0700"
      run_once: true
      delegate_to: localhost

    - name: Generate Kubeadm Token
      ansible.builtin.set_fact:
        kubeadm_token: "{{ token_id }}.{{ token_secret }}"
      vars:
        token_id: "{{ lookup('password', playbook_dir + '/../../output/credentials/kubeadm_token_id length=6 chars=abcdefghijklmnopqrstuvwxyz0123456789') }}"
        token_secret: >-
          {{ lookup('password', playbook_dir + '/../../output/credentials/kubeadm_token_secret length=16 chars=abcdefghijklmnopqrstuvwxyz0123456789') }}
      run_once: true
      delegate_to: localhost

    - name: Generate Certificate Key
      ansible.builtin.set_fact:
        certificate_key: "{{ lookup('password', playbook_dir + '/../../output/credentials/certificate_key length=64 chars=0123456789abcdef') }}"
      run_once: true
      delegate_to: localhost

    - name: Set Cluster Facts
      ansible.builtin.set_fact:
        kubeadm_token: "{{ kubeadm_token }}"
        certificate_key: "{{ certificate_key }}"
        control_plane_endpoint: "{{ hostvars[groups['control_plane'][0]]['ansible_host'] }}:6443"

    - name: Create output directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ output_dir }}"
        - "{{ output_dir }}/http"
        - "{{ output_dir }}/tftp"
        - "{{ output_dir }}/tftp/pxelinux.cfg"

    - name: Ensure tmp kubeadm directory exists
      ansible.builtin.file:
        path: "{{ output_dir }}/tmp/kubeadm"
        state: directory
        mode: "0755"

    - name: Generate Kubeadm Config (Verification only, injected into Ignition)
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/kubeadm.yaml.j2"
        dest: "{{ output_dir }}/tmp/kubeadm/kubeadm-config-{{ inventory_hostname }}.yaml"
        mode: "0755"

    - name: Ensure tmp butane directory exists
      ansible.builtin.file:
        path: "{{ output_dir }}/tmp/butane"
        state: directory
        mode: "0755"

    - name: Generate Butane Config
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/butane_config.yaml.j2"
        dest: "{{ output_dir }}/tmp/butane/butane-{{ inventory_hostname }}.yaml"
        mode: "0755"
      notify:
        - Transpile Butane to Ignition
        - Generate PXE Config

  handlers:
    - name: Transpile Butane to Ignition
      ansible.builtin.command:
        cmd: >-
          butane --pretty --strict {{ output_dir }}/tmp/butane/butane-{{ inventory_hostname }}.yaml
          -o {{ output_dir }}/http/ignition-{{ inventory_hostname }}.json
      changed_when: true

    - name: Generate PXE Config
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/pxe_config.j2"
        dest: "{{ output_dir }}/tftp/pxelinux.cfg/01-{{ mac_address | replace(':', '-') }}"
        mode: "0755"
